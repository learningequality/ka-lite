version: 2.1

jobs:
  build-test:
    working_directory: ~/kalite
    docker:
      - image: circleci/python:2.7-stretch-node-browsers
    steps:
      - browser-tools/install-browser-tools:
          install-firefox: true
          install-geckodriver: true
          install-chrome: false
#          firefox-version: "74.0"
#          geckodriver-version: "v0.26.0"
      - checkout
      - run: pip install -r requirements_sphinx.txt
      - run: pip install -e .
      - run:
          name: "Downgrade Node.js"
          command: |
            curl -sSL "https://nodejs.org/dist/v6.9.5/node-v6.9.5-linux-x64.tar.xz" | sudo tar --strip-components=2 -xJ -C /usr/local/bin/ node-v6.9.5-linux-x64/bin/node
      - run: make assets
      - run: make docs
      - run: firefox -v
      - run: coverage run bin/kalite manage setup --noinput --traceback
      - run: coverage run bin/kalite start --traceback -v2
      - run: sleep 10s  # Necessary for server to be ready
      - run: coverage run bin/kalite status
      - run: coverage run bin/kalite stop --traceback -v2
      - run: coverage run bin/kalite manage test --no-bdd
      - run: coverage run bin/kalite manage test --bdd-only
      - run: bash <(curl -s https://codecov.io/bash)
      # Disable jshint
      # - run: npm install jshint
      # - run: jshint kalite/*/static/js/*/
      - run:
          name: Upload CodeCov.io Data
          command: bash <(curl -s https://codecov.io/bash)
          when: always # Uploads code coverage results, pass or fail

orbs:
  browser-tools: circleci/browser-tools@1.0.0

workflows:
  version: 2
  build_and_test:
    jobs:
      - build-test
