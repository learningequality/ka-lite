{% extends 'base_distributed.html' %}

{% load i18n %}
{% load staticfiles %}

{% block update_active %}active{% endblock update_active %}

{% block title %}{% trans "Video Download" %}{% endblock %}

{% block headcss %}
<link rel="stylesheet" type="text/css" href="{% static 'css/jquery-ui/jquery-ui.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/jquery-ui/plugins/ui.dynatree.css' %}" />

<style>

ul.dynatree-container li, .ui-widget-content {
    background-image: none;
}

.download-actions {
    width: 400px;
    float: left;
    margin-right: 10px;
    margin-top: 5px;
    height: 60px;
    padding: 10px;
}

.subtitles-download {
    width: 500px;
}

.progress-section {
    padding: 5px 0px 0px 0px;
    display: none;
}

.progress-waiting {
    padding: 5px 0px 0px 0px;
    display: none;
}

.subtitle-section {
    padding: 5px 0px 0px 0px;
    display: none;
}

.progress-text {
    color: #005987;
    margin-top: 1.5px;
}

#progressbar-current {
    opacity: 0.9;
    height: 7px;
    margin-top: -7px;
    margin-bottom: 9px;
}

#progressbar-overall {
    opacity: 0.9;
    height: 12px;
    margin-top: -7px
}

#progressbar-subtitle {
	opacity: 0.9;
    height: 12px;
    margin-top: -7px
}

#progressbar-overall .ui-widget-header {
    background: #00A000;
}

#progressbar-current .ui-widget-header {
    background: #00AFD0;
}

#progressbar-subtitle .ui-widget-header {
    background: #C4D831;
}

#download-legend-selected, #download-videos, #delete-videos {
    display: none;
}

#content_tree {
    margin-top: 15px;
}

#cancel-download {
    display: none;
    margin-top: 10px;
}

#download-videos {
    font-weight: bold;
    padding: 4px 10px 5px 10px;
    margin-bottom: 5px;
    color: #52A852;
}

#delete-videos {
    color: #AC4343;
    padding: 0 10px 0 10px;
}

#retry-video-download, #retry-subtitle-download {
    color: red;
    padding: 0 10px 0 10px;
    display: none;
    margin-top: 15px;
}

{% if am_i_online %}
#download-help-link {
    /* nothing yet! */
}
{% endif %}
</style>
{% endblock headcss %}
{% block headjs %}
<script type="text/javascript" src="{% static 'js/jquery-ui/jquery-ui.min.js' %}"></script>
<script src="{% static 'js/jquery.dynatree.min.js' %}"></script>

<script type="text/javascript">
    window.downloading_videos = [];
    window.download_index = 0;
    window.download_subtitle_index = 0;
    
    window.download_check_interval = null;
    window.download_subtitle_check_interval = null;
    
    $(function() {
        
        setTimeout(function() {
            doRequest("/api/get_topic_tree", {})
                .success(function(treeData) {

                    $("#content_tree").dynatree({
                        imagePath:"../images/",
                        checkbox: true,
                        selectMode: 3,
                        children: treeData,
                        debugLevel: 0,
                        onSelect: function(select, node) {
                    
                            var newVideoCount = findSelectedIncompleteVideos().length;
                            var oldVideoCount = findSelectedStartedVideos().length;
                        
                            $("#download-videos").hide();
                            $("#delete-videos").hide();
                            $("#download-legend-unselected").toggle((newVideoCount + oldVideoCount) == 0);
                            $("#help-info").toggle((newVideoCount + oldVideoCount) == 0);
                        
                            if (newVideoCount > 0) {
                                $(".new-video-count").text(newVideoCount);
                                $("#download-videos").show();                                
                            }
                            if (oldVideoCount > 0) {
                                $(".old-video-count").text(oldVideoCount);
                                $("#delete-videos").show();
                            }
                        },
                        onDblClick: function(node, event) {
                            node.toggleSelect();
                        },
                        onKeydown: function(node, event) {
                            if( event.which == 32 ) {
                                node.toggleSelect();
                                return false;
                            }
                        },
                        onPostInit: function() {
                            startDownloadChecks();
                            startSubtitleDownloadChecks();
                        }
                    });
                })
                .fail(function(resp) {
                    handleFailedAPI(resp, "Error downloading topic tree");
                });
        }, 200);
        
    
        $("#progressbar-overall").progressbar({
            value: 0,
            max: 10000000
        });

        $("#progressbar-current").progressbar({
            value: 0,
            max: 100
        });
        
        $("#progressbar-subtitle").progressbar({
            value: 0,
            max: 10000000
        });
    
        $("#download-videos").click(function() {
            var videos = findSelectedIncompleteVideos();            
            var video_queue = $.map(videos, function(node) {
                return node.data.key;
            });

            unselectAllNodes();
            doRequest("/api/start_video_download", {youtube_ids: video_queue})
                .success(
                    startDownloadChecks
                )
                .fail(function(resp) {
                    handleFailedAPI(resp, "Error starting video download");
                });
    	
            $(".progress-section").hide();
            $(".progress-waiting").show();
            $("#cancel-download").show();
            
            ga_track("send", "event", "update", "click-download-videos", "Download Videos", videos.length);
            
        });

        $("#delete-videos").click(function() {
            var videos = findSelectedStartedVideos();
            var video_queue = $.map(videos, function(node) {
                return node.data.key;
            });

            unselectAllNodes();
            
            doRequest("/api/delete_videos", {youtube_ids: video_queue})
                .complete(function() {
                    $.each(video_queue, function(ind, id) {
                        setNodeClass(id, "unstarted");
                    });
                })
                .fail(function(resp) {
                    handleFailedAPI(resp, "Error deleting videos");
                });

            ga_track("send", "event", "update", "click-delete-videos", "Delete Videos", videos.length);
        });

        $(".download-subtitles").click(function(event) {
        
            var new_only = $(event.target).attr("new_only");
            var language = $("#language option:selected").val();
            if (new_only!="true") {
                if(!confirm("{% trans 'You are about to download new subtitles for all downloaded videos. This may take a long time.' %}")) {
                    return;
                }
            }
            
            if (!language) {
                alert("{% trans 'Please select a language first' %}");
            } else {
                doRequest("/api/start_subtitle_download", {language: language, new_only: new_only})
                    .success(
                        startSubtitleDownloadChecks
                    )
                    .fail(function(resp) {
                        handleFailedAPI(resp, "Error downloading subtitles");
                        $(".progress-waiting").hide();
                    });
                $(".progress-waiting").show();

                ga_track("send", "event", "update", "download-subtitles-click", "Download Subtitles (" + language + ")");
            }
        });

        $("#cancel-download").click(function() {
            doRequest("/api/cancel_downloads")
                .success(function() {
                    clearInterval(window.download_check_interval);
                    clearInterval(window.download_subtitle_check_interval);
                    window.downloading_videos = [];
                    window.download_index = 0;
                    window.download_subtitle_index = 0;
            
                    window.download_check_interval = null;
                    window.download_subtitle_check_interval = null;
                    $(".progress-section, .progress-waiting, .subtitle-section, #cancel-download").hide();

                })
                .fail(function(resp) {
                    handleFailedAPI(resp, "Error canceling downloads");
                });

            ga_track("send", "event", "update", "click-cancel-downloads", "Cancel Downloads");
        });
       
        $("#retry-video-download").click(function() {
            doRequest("/api/start_video_download", {})
                .fail(function(resp) {
                    handleFailedAPI(resp, "Error canceling downloads");
                });

            ga_track("send", "event", "update", "click-retry-download", "Retry Download");
        });
    });

    function unselectAllNodes() {
        $.each($("#content_tree").dynatree("getSelectedNodes"), function(ind, node) {
            node.select(false);
        });
    }
    
    function startDownloadChecks() {
        doRequest("/api/get_video_download_list")
            .success(function(video_ids) {
                window.downloading_videos = video_ids;
                window.download_index = 0;
                clearInterval(window.download_check_interval);
                if (video_ids.length == 0) {
                    return;
                }
                window.download_check_interval = setInterval(checkVideoDownloadProgress, 5000);
                checkVideoDownloadProgress();
            })
            .fail(function(resp) {
                handleFailedAPI(resp, "Error getting video download list");
            });
    }
    
    function startSubtitleDownloadChecks() {
    	doRequest("/api/get_subtitle_download_list")
            .success(function(video_ids) {
                window.downloading_subtitles = video_ids;
                window.download_subtitle_index = 0;
                clearInterval(window.download_subtitle_check_interval);
                if (video_ids.length == 0) {
                    $(".progress-waiting").hide();
                    return;
                }
                window.download_subtitle_check_interval = setInterval(checkSubtitleDownloadProgress, 5000);
                checkSubtitleDownloadProgress();
            })
            .fail(function(resp) {
                handleFailedAPI(resp, "Error downloading subtitles list");
            });
    }
    
   	function checkSubtitleDownloadProgress() {
        doRequest("/api/check_subtitle_download")
            .success(function(remainder) {
                if (!window.download_subtitle_check_interval) {
                    return;
                }
                window.download_subtitle_index = window.downloading_subtitles.length - remainder;
                updateSubtitleProgressDisplay();
                if (remainder == 0) {
                    clearInterval(window.download_subtitle_check_interval);
                    $(".progress-subtitle, #cancel-download").hide();
                    return;
                }
            }).
            fail(function(resp) {
                handleFailedAPI(resp, "Error checking subtitles progress");
                clearInterval(window.download_subtitle_check_interval)
            });
    }
    

    function handleFailedAPI(resp, error_text, error_id) {
        if (error_id === undefined) {
            error_id = "id_video_download";
        }
        clear_message(error_id);

        switch (resp.status) {
            case 403:
                // 403 means that we're not authorized to do the action,
                //   which means if we reload we should have to reauthenticate.
                //
                // TODO This is actually a bad idea--could lead to a reload loop (if 403 is
                //   just on the API side), and users lose their settings.
                //   Instead, a message with a link to the login page would be better
                //   (could be opened in a new window, doesn't force things)
                // 
                window.location.reload()
                break;
            default:
                //communicate_api_failure(resp)
                messages = $.parseJSON(resp.responseText);
                if (!("error" in messages)) {
                    // this should be an assert--should never happen
                    show_message("error", error_text + ": " + "Uninterpretable message received.", error_id)
                } else {
                    show_message("error", error_text + ": " + messages["error"], error_id);
                }
                break;
        }
    }

    function checkVideoDownloadProgress() {
        var currentKey = window.downloading_videos[window.download_index];
        doRequest("/api/check_video_download", {youtube_ids: [currentKey]})
            .success(function(progress) {
                if (!window.download_check_interval) {
                    return;
                }
                window.current_download_percent = progress[currentKey];
                updateProgressDisplay();
                if (window.current_download_percent == 100) {
                    setNodeClass(currentKey, "complete");
                    window.download_index++;
                    if (window.download_index >= window.downloading_videos.length) {
                        clearInterval(window.download_check_interval);
                        $(".progress-section, #cancel-download").hide();
                        return;
                    }
                    checkVideoDownloadProgress();
                } else if (!progress["downloading"]) {
                    $("#retry-video-download").show();
                } else {
                    $("#retry-video-download").hide();
                }
            })
            .fail(function(resp) {
                handleFailedAPI(resp, "Error checking video download progress");
            });
    }
    
    function updateProgressDisplay() {
        if (window.download_index < window.downloading_videos.length) {
            if (download_index > 0 || current_download_percent > 0) {
            	$(".progress-section").show();
            	$(".progress-waiting").hide();
                $("#cancel-download").show();
    	 	} else {
                $(".progress-section").hide();
            	$(".progress-waiting").show();
                $("#cancel-download").show();
        	}            
        } else {
            $(".progress-section").hide();
            if ($(".subtitle-section:visible").length == 0) {
                $("#cancel-download").hide();
            }
            return;
        }
        
        $("#progressbar-current").progressbar({value: window.current_download_percent});
        $("#progressbar-overall").progressbar({
            value: window.download_index * 100 + window.current_download_percent,
            max: window.downloading_videos.length * 100
        });

        var currentKey = window.downloading_videos[window.download_index];
        var currentNode = $("#content_tree").dynatree("getTree").getNodeByKey(currentKey);
        $(".video-title").text(currentNode.data.title);
        $(".video-downloading-current").text(window.download_index + 1);
        $(".video-downloading-total").text(window.downloading_videos.length);
   
       
    }
    
    function updateSubtitleProgressDisplay() {
    	
    	if (window.download_subtitle_index < window.downloading_subtitles.length) {
     		$(".subtitle-section, #cancel-download").show();
            $(".progress-waiting").hide();
      	} else {
        	$(".subtitle-section").hide();
            if ($(".progress-section:visible").length == 0) {
                $("#cancel-download").hide();
            }
        return;
    	}
    
        $("#progressbar-subtitle").progressbar({
            value: window.download_subtitle_index * 100,
            max: window.downloading_subtitles.length * 100
    	});
    
        $(".subtitle-downloading-current").text(window.download_subtitle_index);
        $(".subtitle-downloading-total").text(window.downloading_subtitles.length);  
    
    }
    
    function findSelectedIncompleteVideos() {
        var arr = $("#content_tree").dynatree("getSelectedNodes");
        return $.grep(arr, function(node) { 
            return node.data.addClass != "complete" && node.childList == null;
        });
    }

    function findSelectedStartedVideos() {
        var arr = $("#content_tree").dynatree("getSelectedNodes");
        return $.grep(arr, function(node) { 
            return node.data.addClass != "unstarted" && node.childList == null;
        });
    }
    
    function withNodes(nodeKey, callback, currentNode) {
        if (!currentNode) {
            currentNode = $("#content_tree").dynatree("getTree").tnRoot.childList[0];
        }
        $.each(currentNode.childList || [], function(ind, child) {
            if (child.data.key == nodeKey) {
                callback(child);
            }
            withNodes(nodeKey, callback, child);
        });
    }
    
    function setNodeClass(nodeKey, className) {
        withNodes(nodeKey, function(node) {
            $(node.span).removeClass("unstarted partial complete").addClass(className);
            node.data.addClass = className;
            if (node.parent) {
                updateNodeClass(node.parent);
            }            
        });
    }

    function updateNodeClass(node) {
        if (node.childList) {
            var complete = true;
            var unstarted = true;
            for (var i = 0; i < node.childList.length; i++) {
                var child = node.childList[i];
                if (child.data.addClass != "complete") {
                    complete = false;
                }
                if (child.data.addClass != "unstarted") {
                    unstarted = false;
                }
            }
            if (complete) {
                setNodeClass(node.data.key, "complete");
            } else if (unstarted) {
                setNodeClass(node.data.key, "unstarted");
            } else {
                setNodeClass(node.data.key, "partial");
            }
        }
    }

</script>


<script>

{% if not debug %}

    (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,"script","//www.google-analytics.com/analytics.js","ga");

    ga("create", "UA-36937407-3", {"cookieDomain": "none"});

    ga("set", "dimension1", "{% if registered %}Registered{% else %}Unregistered{% endif %}");
    ga("set", "dimension2", "{% if zone_id %}{{ zone_id }}{% endif %}");
    ga("set", "dimension3", "{{ device_id }}");
    ga('set', 'metric1', {{ video_count }});
    
    ga("send", "pageview");
    
{% endif %}

    function ga_track() {
        if (_.isFunction(window.ga)) {
            ga.apply(this, arguments);
        }
    }
    
</script>

{% endblock headjs %}

{% block content %}

<div class="download-actions vertical-shadow">
    <h2 id="download-legend-unselected" class="button_text">
        {% trans "Please select videos to download (below)" %}
    </h2>
    <div id="help-info">
        {% if am_i_online %}
        <a id="download-help-link" target="_new" href="http://{{ central_server_host }}/faq/installation/bittorrent/">
            {% trans "Q: How do I bulk-download videos?" %}
        </a>
        {% endif %}
    </div>
    
    <button id="download-videos" type="button">{% trans "Download " %}<span class="new-video-count">0</span>{% trans " new selected videos" %}</button>
    <button id="delete-videos" type="button">{% trans "Delete " %}<span class="old-video-count">0</span>{% trans " selected videos" %}</button>
</div>

<div class="download-actions subtitles-download vertical-shadow">
    <h2 class="button_text">{% trans "Download/update subtitles for existing videos" %}</h2>
    <span class= "button_style">
        <select id="language">
            {% if languages %}
                {% for language in languages %}
                    <option value="{{ language.id }}" {% ifequal language.id default_language %} selected {% endifequal %}>{{ language.name }}</option>
                {% endfor %}
            {% endif %}
        </select>
    </span>
    <button class="download-subtitles" type="button">{% trans "Get/Update All Subtitles" %}</button>
    <button class="download-subtitles" new_only=true type="button">{% trans "Get Missing Subtitles Only" %}</button>
</div>

<div style="clear: both;"></div>

<div class="progress-waiting">
	<h2 class="progress-text">
        {% trans "Downloads will start soon... Please wait!" %}
    </h2>
</div>

<div class="progress-section">
    
    <h2 class="progress-text">
        {% trans "Downloading video:" %}
        "<span class="video-title"> </span>"...
    </h2>
    
        <div class="progressbar" id="progressbar-current"></div>
        
    <h2 class="progress-text">
        {% trans "Overall video download progress:" %}
        <span class="video-downloading-current">0</span>
        {% trans "of" %}
        <span class="video-downloading-total">0</span>
    </h2>
        
    <div class="progressbar" id="progressbar-overall"></div>
    
    <button id="retry-video-download" type="button">{% trans "Video download error... click to retry" %}</button>
    
</div>

<div class="subtitle-section">
	
    <h2 class="progress-text">
        {% trans "Subtitle download progress:" %}
        <span class="subtitle-downloading-current">5</span>
        {% trans "of" context "e.g. '5 of 9'" %}
        <span class="subtitle-downloading-total">21</span>
    </h2> 
    
    <div class="progressbar" id="progressbar-subtitle"></div>
    
    {# <button id="retry-subtitle-download" type="button">{% trans "Subtitle download error... click to retry" %}</button> #}

</div>

<button id="cancel-download" type="button">{% trans "Cancel All Downloads" %}</button>

<div id="content_tree"><br/><h2>{% trans " Loading topic tree... Please wait!" %}</h2></div>
{% endblock content %}
