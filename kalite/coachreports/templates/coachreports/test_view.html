{% extends "coachreports/base.html" %}

{% load i18n %}
{% load kalite_staticfiles %}
{% load my_filters %}

{% block coachreports_active %}active{% endblock coachreports_active %}
{% block title %}{% trans "Test" %} {{ block.super }}{% endblock title %}

{% block headcss %}{{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'css/coachreports/test_view.css' %}" />
{% endblock headcss %}

{% block headjs %}
    {{block.super}}
    <script>
        $(function(){
            $("#facility").change(function(){
                window.location.href = setGetParamDict(window.location.href, {"facility": $("#facility option:selected").val(), "group": $("#" + $("#facility option:selected").val() + "_group_select").val()});
            });

            $(".group_select").change(function(event){
                window.location.href = setGetParam(window.location.href, "group", $(event.target).val());
            });

            $(window).resize(function() {
                $('.student-header').height($('.data-header').height()+1);
            }).resize();
        })
    </script>
{% endblock headjs %}

{% block report_title %}
    {% trans "Exam Results" %}
{% endblock report_title %}

{% block report_content %}
    <div class="row">
        <div class="col-md-12">
            <div id="legend">
                <div class="legend"><div class="pass"></div>80-100%</div>
                <div class="legend"><div class="borderline"></div>60-79%</div>
                <div class="legend"><div class="fail"></div>0-59%</div>
                <div class="legend"><div class="incomplete"></div>* Incomplete</div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            {% if not results_table.keys or not test_columns %}
                <p>
                    <div class="subtitle error" id="error_message">
                        {% if not results_table.keys %}
                            {% comment %}Everything specified, but no users fit the query.{% endcomment %}
                            {% trans "No student accounts in this group have been created." %}
                        {% else %}
                            {% comment %}Group was selected, but data not queried because a topic was not selected
                            (NOTE: this required knowledge of how the view queries data){% endcomment %}
                            {% trans "No exam results for this group." %}
                        {% endif %}
                    </div>
                </p>
            {% else %}
                {# Student Table #}
                <div class="table-container">
                    <table class="student-table">
                        <thead>
                            <tr>
                                <th class="student-header">
                                    {% trans "Student" %}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in results_table.keys %}
                                <tr>
                                    <th title="({{ student.username }})">
                                        {{ student.name }}
                                    </th>
                                </tr>
                            {% endfor %} 
                            {% for stat in summary_stats %}
                                <tr>
                                    <th class="summary-stat-header">
                                        {{ stat }}
                                    </th>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="results-table">
                        <table>
                            <thead>
                                <tr>
                                    {% for t in test_columns %}
                                        <th class="data-header">
                                            <a class="changeable-link" href="{% url 'test_detail_view' t.test_id %}">{{ t.title }}</a>
                                        </th>
                                    {% endfor %}
                                    {% for s in summary_stats %}
                                        <th class="data-header summary-stat-header">
                                            {{ s }}
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for results in results_table.values %}
                                    <tr>
                                    {% for r in results %}
                                        {% if r.raw_score %}
                                            {% if not r.log.complete and r.log.started %}
                                                <td class="incomplete" title="Incomplete">
                                                    {{ r.display_score }}*
                                                </td>
                                            {% elif r.raw_score > 79 %}
                                                <td class="pass" title="Passed">
                                                    {{r.display_score}}
                                                </td>    
                                            {% elif r.raw_score > 59%}
                                                <td class="borderline" title="Borderline">
                                                    {{r.display_score}}
                                                </td>
                                            {% elif r.raw_score >= 0 %}
                                                <td class="fail" title="Failed">
                                                    {{r.display_score}}
                                                </td>   
                                            {% else %}
                                                <td class="incomplete" title="Incomplete">
                                                </td>
                                            {% endif %}
                                        {% elif r.stat %}
                                            <td>{{ r.stat }}</td>
                                        {% else %}
                                            <td></td>
                                        {% endif %}
                                    {% endfor %}
                                    </tr>    
                                {% endfor %}
                                {% for stats in stats_dict.values %}
                                    <tr>
                                        {% for stat in stats %}
                                            <td>
                                                {{stat}}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock report_content %}